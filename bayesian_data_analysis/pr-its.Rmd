---
title: "Prior in the sky (prits)"
author: "mht"
date: "April 4, 2015"
output: html_document
---

```{r}
library(rstan)
setwd("~/Documents/research/sinking-marbles/bayesian_data_analysis/")
dir()
```

```{r}

model <- "
// Give a number task
data { 
  int<lower=1> subjects;
  int<lower=0> states;
  int<lower=1> items;
  int<lower=0,upper=99> ntdata[items,subjects];
  int d_na[items,subjects];  // locating NAs in ntdata
  int n_na;         // number of NAs
}
parameters {
  matrix<lower=0,upper=1>[items,states] prits; 
  vector<lower=0>[subjects] alpha;
  real<lower=0> big_alpha;
}
transformed parameters {
  vector[states] exp_prits[subjects,items];
// make this into array of arrays somehow
  for (i in 1:subjects){
    for (j in 1:items){
      for (k in 1:states){
        exp_prits[i,j,k] <- pow(prits[j,k],alpha[i]);
      }
      exp_prits[i,j] <- exp_prits[i,j]/sum(exp_prits[i,j]);
    }
  }
}

model {

  // Priors
  
  for (j in 1:items)
    for (k in 1:states)
      prits[j,k] ~ beta(1,1);

  for (i in 1:subjects)
      alpha[i] ~ lognormal(1,1);

  for (j in 1:items){
    for (i in 1:subjects){
      if (d_na[j,i] == 0){     // If ntdata[j,i] is not missing
        ntdata[j,i] ~ categorical(exp_prits[i,j]);
      }
  }
}
}
generated quantities {
  int na_array[n_na];
  int index;
  
  index <- 1;
  for (j in 1:items) {
    for (i in 1:subjects) {   
      if (d_na[j,i] == 1) {   // If ntdata[j,i] is missing
        na_array[index] <- categorical_rng(exp_prits[i,j]);
        index <- index + 1;
      }
    }
  }
}
"
```


```{r}

allpriors<-read.csv(file="inferpriorinsky_number.txt", sep='\t')
f<-allpriors %>% gather(key, value,-workerid)
d<-acast(f,key~workerid)

d[d==-1] <- NA

subjects <- length(d[1,])  # number of subjects
items <- length(d[,1])  # number of items
states <- 16 # number of states

d_na <- is.na(d) + 0  # Matrix locating missing values: 1 = missing
n_na <- sum(d_na)  # number of missing values
d=d+1  # add 1 for sake of the categorical
d[is.na(d)] <- 99  # some numeric value, since Stan doesn't eat NAs
  
parameters <- c("prits","alpha","na_array")  # parameters to be monitored   

data <- list(ntdata=d, 
             subjects=subjects,
             items=items,
             states=states,
             d_na=d_na,
             n_na=n_na) # to be passed on to Stan

fit0 <- stan(model_code=model, data = data, chains = 0)

# fit0<-stan(fit=foo, 
#      data = data, 
#      iter = 1000,
#      pars=parameters,
#      chains = 2)


sflist <- 
  mclapply(1:4, mc.cores = 2, 
           function(i) stan(fit = fit0, 
                            pars=parameters,
                            data = data, 
                            chains = 1, 
                            chain_id = i,
                            iter=500,
                            thin=10,
                            refresh = -1))

fit1 <- sflist2stanfit(sflist)


df<-data.frame(fit1@sim$samples)

sky.prior<-df %>% select(starts_with('prits')) %>%
  gather(key,value) %>%
  separate(key, c("dull","item","state","chain")) %>%
  select(-dull) %>%
  mutate(chain = factor(chain, labels=c(1,2,3,4))) %>%
  group_by(item,state) %>%
#   summarise(posterior.median = median(value),
#             posterior.975 = quantile(value,probs=.975),
#             posterior.025 = quantile(value,probs=.025),
#             sterr = sem(value))
#   group_by(key) %>%
  summarise(expval = mean(value)) %>%
  #mutate(key=as.character(key)) %>%
  ungroup() %>%
  group_by(item) %>%
  mutate(total = sum(expval)) %>%
  ungroup() %>%
  group_by(item, state) %>%
  mutate(norm_expval = expval/total)

sky.prior<- sky.prior %>%
  ungroup() %>%
  mutate(item = factor(sky.prior$item, levels=seq(1,90), labels =levels(f$key)),
         state = to.n(state)-1)


ggplot(sky.prior,aes(x=value))+
  geom_histogram()+
  facet_grid(state~item)
ggsave(file='STAN_numbertask_iter100x4_lognormal_stateXitem.png', height=30, width=30)

plt1<-ggplot(sky.prior,aes(x=state, y= norm_expval))+
  geom_bar(stat='identity',position=position_dodge())+
 # geom_errorbar(aes(ymin=posterior.025, ymax=posterior.975), 
 #               position=position_dodge())+
  facet_wrap(~item)

ggsave(plot=plt1,file='STAN_numbertask_iter1000_lognormal_mean1.png',height=20, width=30)



alpha.subj<-df %>% select(starts_with('alpha'))%>%
  gather(key,value) 

ggplot(alpha.subj,aes(x=value))+
  geom_histogram(binwidth=0.2)+
  facet_wrap(~key)
#+
#  xlim(0,5)

qplot(df$big_alpha,geom='histogram')

```







